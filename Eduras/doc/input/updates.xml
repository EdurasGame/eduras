<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD Simplified DocBook XML V1.0//EN"
"http://www.oasis-open.org/docbook/xml/simple/1.0/sdocbook.dtd">
<article>
	<articleinfo>
		<title>Update mechanism</title>
		<author>
			<firstname>Jannis</firstname>
			<surname>Mell</surname>
		</author>
	</articleinfo>
	<section>
		<title>What's this about?</title>
		<para>
			This chapter describes the newly implemented automatic
			update mechanism.
		</para>
		<para>
			To learn more about the game launcher, take a look at
			chapter "Launcher &amp; Community".
		</para>
	</section>
	<section>
		<title>Features</title>
		<para>
			The update mechanism of Eduras? supports a lot of
			features that makes updating easier:
		</para>
		<itemizedlist>
			<listitem>
				<para>checking for newer eduras versions</para>
			</listitem>
			<listitem>
				<para>automated updating of the game</para>
			</listitem>
			<listitem>
				<para>incremental updates</para>
			</listitem>
			<listitem>
				<para>change launcher config values</para>
			</listitem>
			<listitem>
				<para>repair installation</para>
			</listitem>
			<listitem>
				<para>different release-channels</para>
			</listitem>	
			<listitem>
				<para>launcher self-updating</para>
			</listitem>			
		</itemizedlist>
		<section>
			<title>Planned features</title>
			<itemizedlist>
				<listitem>
					<para>
						Automate publishing of new releases
					</para>
				</listitem>
			</itemizedlist>
		</section>
		<section>
			<title>What's not supported</title>
			<para>
				There are not many things that are not supported.
				We do not miss any feature at the moment, but if
				there occurs a need, we are able to implement it.
			</para>
		</section>
	</section>
	<section>
		<title>Mechanism</title>
		<para>
			Before the launcher allows the user to start the game,
			it checks if game's version is up to date.
			The following scheme illustrates the launcher's behaviour:
		</para>
		<figure>
            <title>Launcher's mechanism to check for game updates</title>
            <mediaobject>
                <imageobject>
                    <imagedata fileref="images/launcher-state.png" format="PNG" />
                </imageobject>
            </mediaobject>
	    </figure>
	    <section>
	    	<title>Release channels</title>
	    	<para>
	    		Eduras supports multiple release channels that exist side by side.
	    		The current release channels are
	    		<computeroutput>STABLE, BETA, NIGHTLY</computeroutput> whereas
				<computeroutput>BETA</computeroutput> is not maintained at the moment.
				Users can switch between release channels using a dropdown menu
				in the game launcher.
			</para>	    	
	    </section>
	</section>
	<section>
		<title>Server structure</title>
		<para>
			On the server, there exists a <computeroutput>update</computeroutput>-folder that
			contains <computeroutput>version.xml</computeroutput> and several other files.
			The following listing explains the directory structure:
		</para>
		<programlisting>update/
  |
  |-version.xml
  |-beta.xml
  |-nightly.xml
  |-eduras-setup.jar
  |-lupdater.jar - the launcher updater 
  |-eduras.jar - the current launcher
  |-files/
  |  |-eduras-client-1.4.jar - gameclient versions
  |  \-eduras-client-1.5.jar
  \-nightly/
     \-eduras-client.jar</programlisting>
	</section>
	<section>
		<title>version.xml</title>
		<para>
			The <computeroutput>version.xml</computeroutput> file contains
			all required information
			for the game launcher to be able to connect to
			Eduras? servers. It contains data about current client
			version and update changes.
			It is queried everytime the launcher is started.
		</para>
		<para>
			A minimum version of this file looks like the following whereas
			a detailed one could be twice long.
			Tags are explained below.
		</para>
		<programlisting>&lt;xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;
&lt;updateInformation&gt;
	&lt;metaserver&gt;http://illonis.dyndns.org:4324&lt;/metaserver&gt;
	&lt;homepage&gt;http://www.eduras.de&lt;/homepage&gt;
	&lt;updateUrl&gt;http://illonis.dyndns.org/eduras/update/version.xml&lt;/updateUrl&gt;
	&lt;version&gt;0.3&lt;/version&gt;
	&lt;releaseName&gt;alpha3&lt;/releaseName&gt;
	&lt;releaseDate&gt;2013-02-13 14:22&lt;/releaseDate&gt;
	&lt;gameJar&gt;eduras.jar&lt;/gameJar&gt;
	
	&lt;changeset from="0"&gt;
		&lt;size&gt;13331&lt;/size&gt;
		&lt;baseUrl&gt;http://illonis.dyndns.org/eduras/update/files/&lt;/baseUrl&gt;
		&lt;files&gt;
			&lt;file size="13331" md5="a3cca2b2aa1e3b5b3b5aad99a8529074"&gt;eduras.jar&lt;/file&gt;
		&lt;/files&gt;
	&lt;/changeset&gt;
&lt;/updateInformation&gt;</programlisting>
		<itemizedlist>
			<listitem>
				<para><emphasis>metaserver</emphasis> - the url to the eduras metaserver</para>
			</listitem>
			<listitem>
				<para><emphasis>homepage</emphasis> - the url to the eduras homepage</para>
			</listitem>
			<listitem>
				<para><emphasis>updateUrl</emphasis> - this might be rather irritating but update url
				might change.</para>
			</listitem>
			<listitem>
				<para><emphasis>version</emphasis> - the currently up-to-date version of eduras on the server</para>
			</listitem>
			<listitem>
				<para><emphasis>releaseName</emphasis> - the human readable release name (additionaly to the version)</para>
			</listitem>
			<listitem>
				<para><emphasis>releaseDate</emphasis> - the release date of the current version</para>
			</listitem>
			<listitem>
				<para><emphasis>gameJar</emphasis> - the name (+path) of the game jar in this version (required to
				start the game from launcher)</para>
			</listitem>
			<listitem>
				<para><emphasis>changeset</emphasis> - this block contains an entire changeset. Take a look at the next
				section to learn about changesets.</para>
			</listitem>
		</itemizedlist>
		<para>
			There are even more...
		</para>
		<para>The <computeroutput>launcher</computeroutput>-tag allows you to initiate a launcher
		update. It specifies the new launcher version and the launcher-updater file:</para>
		<programlisting>&lt;launcher&gt;
	&lt;version&gt;2.0&lt;/version&gt;
	&lt;note&gt;This note will be displayed to user after updating launcher (optional).&lt;/note&gt;
	&lt;baseUrl&gt;http://illonis.dyndns.org/eduras/update/&lt;/baseUrl&gt;
	&lt;name&gt;eduras.jar&lt;/name&gt;
	&lt;size&gt;113282&lt;/size&gt;
	&lt;updater&gt;lupdater.jar&lt;/updater&gt;
	&lt;updatersize&gt;113290&lt;/updatersize&gt;
&lt;/launcher&gt;</programlisting>
		<para>
			After downloading the new launcher to <computeroutput>eduras.jar.new</computeroutput>,
			the launcher-updater is executed and launcher is terminated. The launcher-updater replaces
			the old launcher with the new one and starts it again. Then the content of the
			<computeroutput>note</computeroutput>-Tag will be displayed. The submission of this tag
			is optional.
		</para> 
		<para>
			A launcher update will only be started if server's launcher version is newer than client's.
		</para>
		<section>
			<title>Changesets</title>
			<para>
				Using changesets, the update mechanism supports incremental updates.
				This means, updating from <computeroutput>2.9</computeroutput> to
				<computeroutput>3.0</computeroutput> does not require to load all files
				of the new version but only the files that changed between those versions.
			</para>
			<para>
				Changesets always update to the current version. Every changeset must specify
				by which version it is allowed to be used. The <computeroutput>from</computeroutput>
				parameter specifies this version. If the changeset specifies
				<computeroutput>from="2.8"</computeroutput> and the current version is 
				<computeroutput>3.0</computeroutput>, all
				clients with version <computeroutput>2.8</computeroutput> can use this
				changeset to update to <computeroutput>3.0</computeroutput> immediately
				instead of downloading everything new.
			</para>
			<para>
				You can specify any number of changesets within
				<computeroutput>[1,number_versions]</computeroutput>.
				The following illustration, which is described below, should give you an idea.
			</para>
			<figure>
	            <title>incremental updates using changesets</title>
	            <mediaobject>
	                <imageobject>
	                    <imagedata fileref="images/incremental-updates.png" format="PNG" />
	                </imageobject>
	            </mediaobject>
	        </figure>
	        <orderedlist>
	        	<listitem>
	        		<para>There is only one release. So every launcher
	        		(freshly downloaded is always version <computeroutput>0</computeroutput>)
	        		must update to the new version.
	        		This is rather simple: one relase - one way to update.
	        		</para>
	        	</listitem>
	        	<listitem>
	        		<para>
	        			If there exist two changesets - one from <computeroutput>0</computeroutput>
	        			and one from <computeroutput>1.0</computeroutput>, version
	        			<computeroutput>1.0</computeroutput> can update directly to <computeroutput>1.1</computeroutput>.
	        			All other versions must perform a full update.
	        		</para>
	        	</listitem>
	        	<listitem>
	        		<para>Clients with <computeroutput>1.1</computeroutput> and higher
	        		can use changesets to directly update to <computeroutput>2.0</computeroutput>.
	        		Version <computeroutput>1.0</computeroutput> is incompatible so it
	        		must perform a full update (use <computeroutput>from="0"</computeroutput>).
	        		</para>
	        	</listitem>
	        	<listitem>
	        		<para>
	        			The <computeroutput>from="2.0"</computeroutput> changeset forces
	        			a clean. That means, all files will be removed from client and
	        			a full update is done then.
	        		</para>
	        		<para>
		        		It might sound kind of unrealistic that lower versions are
		        		better compatible. Admins should have used a single changeset with
		        		<computeroutput>from="0"</computeroutput>
		        		and <computeroutput>forceClean</computeroutput> flag instead.
		        	</para>
	        	</listitem>
	        </orderedlist>
	        <section>
	        	<title>Changeset content</title>
	        	<para>
	        		A changeset contains six parameters that define changes:
	        	</para>
	        	<itemizedlist>
	        		<listitem>
	        			<para><emphasis>note</emphasis> (optional) - an update note that will be displayed to user.</para>
	        		</listitem>
	        		<listitem>
	        			<para><emphasis>size</emphasis> - the total size of all download files</para>
	        		</listitem>
	        		<listitem>
	        			<para><emphasis>forceClean</emphasis> - a flag whether all old files should be deleted</para>
	        		</listitem>
	        		<listitem>
	        			<para><emphasis>baseUrl</emphasis> - the base url to update files</para>
	        		</listitem>
	        		<listitem>
	        			<para><emphasis>files</emphasis> - a set of files that needs to be downloaded.
	        			</para>
	        			<para>Each file tag contains the file's size, md5-hash
	        			and name (see example).</para>
	        		</listitem>
	        		<listitem>
	        			<para><emphasis>deletes</emphasis> - a set of files that will be deleted <emphasis>after</emphasis>
	        			downloading new files.</para>
	        			<warning>
	        				<para>
	        					Care to not delete recently downloaded files. If you download
	        					a file with a name that already exists locally, the local one will
	        					be overwritten.
	        				</para>
	        			</warning>
	        		</listitem>
	        		<listitem>
	        			<para><emphasis>configChanges</emphasis> - a set of configuration key-value pairs that should
	        			be updated (see section "config parameters").
	        			</para>
	        		</listitem>	        	
	        	</itemizedlist>
	        	<para>
	        		The following code snippet shows an example of a changeset:
	        	</para>
	        	<programlisting>&lt;changeset from="2.0"&gt;
	&lt;note&gt;This note will be displayed to user after updating.&lt;/note&gt;
	&lt;size&gt;13411&lt;/size&gt;
	&lt;forceClean&gt;true&lt;/forceClean&gt;
	&lt;baseUrl&gt;http://illonis.dyndns.org/eduras/update/files/&lt;/baseUrl&gt;
	&lt;files&gt;
		&lt;file size="13411" md5="a3cca2b2aa1e3b5b3b5aad99a8529074"&gt;eduras.txt&lt;/file&gt;
	&lt;/files&gt;
	&lt;deletes&gt;
		&lt;file&gt;old.txt&lt;/file&gt;
	&lt;/deletes&gt;
	&lt;configChanges&gt;
		&lt;config key="abc"&gt;value&lt;/config&gt;
	&lt;/configChanges&gt;
&lt;/changeset&gt;</programlisting>
	        </section>
		</section>
	</section>
</article>